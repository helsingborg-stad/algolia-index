<?php

namespace AlgoliaIndex\Helper;

class Options
{
    /**
     * Checking if basic config is present
     *
     * @return bool
     */

    public static function isConfigured()
    {
        return !(bool) \apply_filters(
            'AlgoliaIndex/Options/IsConfigured',
            (empty(self::applicationId()) || empty(self::apiKey()))
        );
    }

    /**
     * Get the app-id
     *
     * @return string $appId
     */
    public static function applicationId()
    {
        //Database
        $dbOption = self::getOption()['application_id'];
        if (!empty($dbOption) && is_string($dbOption)) {
            return $dbOption;
        }

        if (defined('ALGOLIAINDEX_APPLICATION_ID') && !empty(ALGOLIAINDEX_APPLICATION_ID)) {
            return ALGOLIAINDEX_APPLICATION_ID;
        }

        return false;
    }

    /**
     * Get the api key
     *
     * @return string $apiKey
     */
    public static function apiKey()
    {
        //Database
        $dbOption = self::getOption()['api_key'];
        if (!empty($dbOption) && is_string($dbOption)) {
            return $dbOption;
        }

        if (defined('ALGOLIAINDEX_API_KEY') && !empty(ALGOLIAINDEX_API_KEY)) {
            return ALGOLIAINDEX_API_KEY;
        }

        return false;
    }

    /**
     * Get the api key
     *
     * @return string $apiKey
     */
    public static function publicApiKey()
    {
        //Database
        $options = self::getOption();

        if (isset($options['public_api_key']) && !empty($options['public_api_key']) && is_string($options['public_api_key'])) {
            return $options['public_api_key'];
        }
        
        if (defined('ALGOLIAINDEX_PUBLIC_API_KEY') && !empty(ALGOLIAINDEX_PUBLIC_API_KEY)) {
            return ALGOLIAINDEX_PUBLIC_API_KEY;
        }
        
        return false;
    }

     /**
     * Get or automatically create a index name, if not set by the developer.
     *
     *  - Index name will be the hostname as default.
     *  - Subfolder sites will share search index by default.
     *
     * @return string $indexName
     */
    public static function indexName()
    {
        //Database
        $dbOption = self::getOption()['index_name'];
        if (!empty($dbOption) && is_string($dbOption)) {
            return $dbOption;
        }
      
        //Constant
        if (defined('ALGOLIAINDEX_INDEX_NAME') && !empty(ALGOLIAINDEX_INDEX_NAME)) {
            return ALGOLIAINDEX_INDEX_NAME;
        }

        //Use autogenerated index name, mutisites using subfolder structure will use the same index by default.
        return apply_filters("AlgoliaIndex/GeneratedIndexName", str_replace(".", "-", parse_url(get_option('home'))['host']));
    }

    /**
     * Get facetting option
     *
     * @return array $facetting
     */
    public static function facetting()
    {
        $fieldData = get_field('algolia_index_facetting', 'option');
        if (empty($fieldData) || !is_array($fieldData)) {
            return null;
        }
        $facetting = isset($fieldData) && is_array($fieldData) ? $fieldData : [];
        return apply_filters(
            'AlgoliaIndex/Options/Facetting',
            $facetting
        );
    }

    /**
     * Get option and enshure that all keys exists.
     *
     * @return array
     */
    private static function getOption()
    {
        return [
            'application_id'    => get_field('algolia_index_application_id', 'option') ?: '', 
            'api_key'           => get_field('algolia_index_api_key', 'option') ?: '',
            'public_api_key'    => get_field('algolia_index_public_api_key', 'option') ?: '',
            'index_name'        => get_field('algolia_index_index_name', 'option') ?: ''
        ];
    }
}
